define(["modules/util/util.instances","modules/util/util.model","jq!starfield/jquery.mod","libs/fancybox/fancybox"],function(e,t,n){function i(e,n){this.$element=e,this.model=new t(n),this.mode=this.model.get("mode"),this.i18N=this.model.get("i18N"),this.subscriptions=[],this.init()}var r="wsb-media-carousel";i.prototype={$titleTemplate:!1,init:function(){var e=this;if(this.model.isKO){var t=function(){e.refresh()};this.subscriptions.push(this.model.get("localizedAssets",!0).subscribe(t));var r=this.model.get("mutatorViewModel",!0);if(r)for(var i in r)this.model.ko.isObservable(r[i])&&this.subscriptions.push(r[i].subscribe(t))}this.$titleTemplate||(this.$titleTemplate=n("<div/>").addClass("fancybox-title fancybox-title-float-wrap").append(n("<span/>").addClass("child"))),this.refresh(this.mode=="designer"&&this.model.get("isNew"))},refresh:function(e){this.assets=this.model.get("localizedAssets")||this.model.get("CarouselAssets"),this.$element.children().remove();for(var t=0;t<this.assets.length;t++)this.addAsset(this.assets[t],t+1);if(this.mode=="designer")this.model.set("minWidth",n("> a:first",this.$element).outerWidth(!0)),this.model.set("isNew",e),this.updateOverlay();else if(this.mode=="desktop"){var r=this,i=!1,s=n("a",this.$element),o=this.model.get("preview"),u=this.model.get("CarouselCaption");s.selector="",s.fancybox({afterLoad:function(e){i=e},afterShow:function(){if(i){var e=r.assets[i.index];if(e){n(".fancybox-next").attr("title",r.i18N.resources.Next),n(".fancybox-prev").attr("title",r.i18N.resources.Previous);if(u||e.link){var t=n(".fancybox-title",i.theme);t.length||(t=r.$titleTemplate.clone().insertAfter(n(".fancybox-outer",i.skin)));if(e.link){var s=n("<a/>").addClass("fancy-title-float-wrap-link").attr("href",e.link);Boolean(e.link.match(/^((http|https|ftp|mailto):|\/\/)/i))?s.attr("target","_blank"):o&&s.one("click",function(){n.fancybox.close()}),s.appendTo(t)}u&&!e.caption&&n("span",t).text(r.i18N.resources.Image+" "+(i.index+1)+"/"+r.assets.length)}}}},beforeClose:function(){i=!1}})}},updateOverlay:function(){var e=n("."+r+"-overlay",this.$element);e.length||n("<div/>").addClass(r+"-overlay").css({filter:"alpha(opacity = 0)","background-color":"transparent"}).appendTo(this.$element)},addAsset:function(e){var t=this,i=e.src||"/document/"+e.id,s=this.model.get("CarouselCaption")&&e.caption?e.caption:null,o=i,u=null;this.mode=="mobile"&&e.link&&(o=e.link,Boolean(e.link.match(/^((https?|ftp|file):\/{2}|mailto:)/i))&&(u="_blank"));var a=n("<a/>").addClass(r+"-wrapper").addClass("loading").css({height:"100%",width:"100%"}).attr({rel:r+"-"+this.mode+"-"+this.model.get("ID"),href:o,title:s,target:u,"data-fancybox-type":"image"}).css({height:this.model.get("CarouselThumbSize"),width:this.model.get("CarouselThumbSize"),margin:this.model.get("CarouselThumbSpacing"),display:"inline-block","vertical-align":"middle"}).appendTo(this.$element),f=n("<img/>").bind("load",function(){f.appendTo(a.removeClass("loading"));var e=f.width(),n=f.height(),r=a.width(),i=a.height();e>n?f.css({height:i,left:-(e*(i/n)-r)/2}):e<n?f.css({width:r,top:-(n*(r/e)-i)/2}):f.css({width:r,height:i});var s=t.model.get("CarouselTheme");s&&a.addClass(s),f.unbind("load")});f[0].src=i},destroy:function(){for(var e in this.subscriptions)this.subscriptions[e].dispose();s.destroy(this.$element),this.$element.remove()}};var s=new e(r,i);return{render:function(e,t){var n=s.get(e);return n?n.refresh():n=s.create(e,t),n},destroy:function(e){var t=s.get(e);return t?(s.destroy(e),!0):!1}}});